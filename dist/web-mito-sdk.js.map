{"version":3,"file":"web-mito-sdk.js","sources":["../src/util/ajax.js","../src/index.js","../src/module/watchApiErrorXhr.js","../src/module/watchApiErrorFetch.js","../src/module/watchJsError.js","../src/module/watchResourceError.js"],"sourcesContent":["export  function ajax(opt) {\n  var that = this;\n  return new Promise(function (resolve, reject) {\n    var xmlHttp = new XMLHttpRequest();\n    xmlHttp.open(opt.method, opt.url);\n    if (\n      opt.method.toUpperCase() === \"GET\" ||\n      opt.method.toUpperCase() === \"DELETE\"\n    ) {\n      xmlHttp.send(null);\n    } else if (opt.method.toUpperCase() === \"POST\") {\n      var body = JSON.stringify(opt.data);\n      xmlHttp.setRequestHeader(\"Content-Type\", \"application/json\");\n      xmlHttp.send(body);\n    }\n    xmlHttp.onreadystatechange = function () {\n      if (xmlHttp.readyState == 4) {\n        if (xmlHttp.status == 200) {\n          try {\n            var response =\n              typeof xmlHttp.responseText === \"string\"\n                ? JSON.parse(xmlHttp.responseText)\n                : xmlHttp.responseText;\n            resolve(response);\n          } catch (e) {\n            reject(e);\n          }\n        } else {\n          reject(xmlHttp);\n        }\n      }\n    };\n  });\n}\n\n","import { watchApiErrorXhr } from \"./module/watchApiErrorXhr.js\";\nimport { watchApiErrorFetch } from \"./module/watchApiErrorFetch.js\";\nimport { watchJsError } from \"./module/watchJsError.js\";\nimport { watchResourceError } from \"./module/watchResourceError.js\";\n\n(function () {\n  const { name } = getScriptQuery();\n  watchApiErrorXhr(name);\n  watchApiErrorFetch(name);\n  watchJsError(name);\n  watchResourceError(name);\n})();\n","import { ajax } from \"../util/ajax.js\";\nexport function watchApiErrorXhr(name) {\n  function hijackXHR() {\n    const proto = window.XMLHttpRequest.prototype;\n    const originalOpen = proto.open;\n    const originalSend = proto.send;\n    var _handleEvent = function (event) {\n      if (event && event.currentTarget && event.currentTarget.status !== 200) {\n        // 自定义错误上报 }\n        ajax({\n          method: \"POST\",\n          url: \"http://10.69.57.179:30001/logapi/addErrorLog\",\n          data: {\n            title: event.currentTarget.responseText,\n            type: \"apiError\",\n            detail:\n              event.currentTarget.responseURL +\n              \"：\" +\n              event.currentTarget.status +\n              \"&\" +\n              event.currentTarget.statusText,\n            component: name,\n            description: event.currentTarget.responseURL,\n          },\n        });\n        console.log(event.currentTarget);\n      }\n    };\n    // proto.open = function (method, url, async) {\n    //   this._ctx = {\n    //     url: url || \"\",\n    //     method,\n    //   };\n    //   return originalOpen.apply(this, arguments);\n    // };\n    proto.send = function () {\n      if (this[\"addEventListener\"]) {\n        this[\"addEventListener\"](\"error\", _handleEvent);\n        this[\"addEventListener\"](\"load\", _handleEvent);\n        this[\"addEventListener\"](\"abort\", _handleEvent);\n      } else {\n        var _oldStateChange = this[\"onreadystatechange\"];\n        this[\"onreadystatechange\"] = function (event) {\n          if (this.readyState === 4) {\n            _handleEvent(event);\n          }\n          _oldStateChange && _oldStateChange.apply(this, arguments);\n        };\n      }\n      return originalSend.apply(this, arguments);\n    };\n  }\n  window.XMLHttpRequest && hijackXHR();\n}\n","import { ajax } from \"../util/ajax.js\";\nexport function watchApiErrorFetch(name) {\n  if (!window.fetch) return;\n  let _oldFetch = window.fetch;\n  window.fetch = function () {\n    return _oldFetch\n      .apply(this, arguments)\n      .then((res) => {\n        if (!res.ok) {\n          // True if status is HTTP 2xx\n          // 上报错误\n          ajax({\n            method: \"POST\",\n            url: \"http://10.69.57.179:30001/logapi/addErrorLog\",\n            data: {\n              title: res.statusText,\n              type: \"apiError\",\n              detail: res.url + \"：\" + res.status + \"&\" + res.statusText,\n              component: name,\n              description: res.url,\n            },\n          });\n          console.log(res);\n        }\n        return res;\n      })\n      .catch((error) => {\n        // 上报错误\n        ajax({\n          method: \"POST\",\n          url: \"http://10.69.57.179:30001/logapi/addErrorLog\",\n          data: {\n            title: error.message,\n            type: \"apiError\",\n            detail: encodeURI(error.stack),\n            component: name,\n            description: encodeURI(error.stack),\n          },\n        });\n        console.log(error);\n        throw error;\n      });\n  };\n}\n","import { ajax } from \"../util/ajax.js\";\nexport function watchJsError(name) {\n  window.addEventListener(\n    \"error\",\n    (event) => {\n      if (!event.target.localName) {\n        ajax({\n          method: \"POST\",\n          url: \"http://10.69.57.179:30001/logapi/addErrorLog\",\n          data: {\n            title: event.error.message,\n            type: \"jsError\",\n            detail: encodeURI(event.error.stack),\n            component: name,\n            description: event.filename,\n          },\n        });\n        console.log(event);\n      }\n    },\n    true\n  );\n\n  window.addEventListener(\"unhandledrejection\", (event) => {\n    ajax({\n      method: \"POST\",\n      url: \"http://10.69.57.179:30001/logapi/addErrorLog\",\n      data: {\n        title: event.reason.message,\n        type: \"jsError\",\n        detail: encodeURI(event.reason.stack),\n        component: name,\n        description: encodeURI(event.reason.stack),\n      },\n    });\n    console.log(event);\n  });\n\n  // if (type == \"VUE\") {\n  //   config.errorHandler = function (err, vm, info) {\n  //     ajax({\n  //       method: \"POST\",\n  //       url: \"http://10.69.57.179:30001/logapi/addErrorLog\",\n  //       data: {\n  //         title: err.message,\n  //         type: \"vueError\",\n  //         detail: encodeURI(err.stack),\n  //         component: name,\n  //         description: `组件${vm.$vnode.tag}发生错误：${err.message}, ${info}`,\n  //       },\n  //     });\n  //     console.log(err);\n  //   };\n  // }\n}\n","import { ajax } from \"../util/ajax.js\";\nexport function watchResourceError(name) {\n  window.addEventListener(\n    \"error\",\n    (event) => {\n      if (event.target.localName) {\n        ajax({\n          method: \"POST\",\n          url: \"http://10.69.57.179:30001/logapi/addErrorLog\",\n          data: {\n            title: event.target.localName + \"资源错误\",\n            type: \"resourceError\",\n            detail: event.target.outerHTML,\n            component: name,\n            description: `引用${event.target.currentSrc}失败`,\n          },\n        });\n        console.log(event);\n      }\n    },\n    true\n  );\n}\n"],"names":["ajax","opt","Promise","resolve","reject","xmlHttp","open","method","url","toUpperCase","send","JSON","stringify","data","setRequestHeader","body","onreadystatechange","readyState","status","responseText","parse","response","e","name","watchApiErrorXhr","proto","originalSend","_handleEvent","window","XMLHttpRequest","prototype","event","currentTarget","title","type","detail","responseURL","statusText","component","description","console","log","this","_oldStateChange","apply","arguments","getScriptQuery","fetch","_oldFetch","then","res","ok","error","message","encodeURI","stack","watchApiErrorFetch","addEventListener","target","localName","filename","reason","watchJsError","outerHTML","currentSrc","watchResourceError"],"mappings":"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"}