{"version":3,"file":"web-mito-sdk.modern.mjs","sources":["../src/util/ajax.js","../src/index.js","../src/module/watchJsError.js","../src/module/watchApiErrorXhr.js","../src/module/watchApiErrorFetch.js","../src/module/watchResourceError.js"],"sourcesContent":["export  function ajax(opt) {\n  var that = this;\n  return new Promise(function (resolve, reject) {\n    var xmlHttp = new XMLHttpRequest();\n    xmlHttp.open(opt.method, opt.url);\n    if (\n      opt.method.toUpperCase() === \"GET\" ||\n      opt.method.toUpperCase() === \"DELETE\"\n    ) {\n      xmlHttp.send(null);\n    } else if (opt.method.toUpperCase() === \"POST\") {\n      var body = JSON.stringify(opt.data);\n      xmlHttp.setRequestHeader(\"Content-Type\", \"application/json\");\n      xmlHttp.send(body);\n    }\n    xmlHttp.onreadystatechange = function () {\n      if (xmlHttp.readyState == 4) {\n        if (xmlHttp.status == 200) {\n          try {\n            var response =\n              typeof xmlHttp.responseText === \"string\"\n                ? JSON.parse(xmlHttp.responseText)\n                : xmlHttp.responseText;\n            resolve(response);\n          } catch (e) {\n            reject(e);\n          }\n        } else {\n          reject(xmlHttp);\n        }\n      }\n    };\n  });\n}\n\n","import { watchApiErrorXhr } from \"./module/watchApiErrorXhr.js\";\nimport { watchApiErrorFetch } from \"./module/watchApiErrorFetch.js\";\nimport { watchJsError } from \"./module/watchJsError.js\";\nimport { watchResourceError } from \"./module/watchResourceError.js\";\n\nexport class webMitoSdkInit {\n  constructor({ name, type, config, sendApi, sendResource, sendJsError }) {\n    this.name = name;\n    this.type = type;\n    this.config = config;\n    this.sendApi = sendApi;\n    this.sendJsError = sendJsError;\n    this.sendResource = sendResource;\n  }\n  init() {\n    this.sendApi && watchApiErrorXhr(this.name);\n    this.sendApi && watchApiErrorFetch(this.name);\n    this.sendJsError && watchJsError(this.name, this.type, this.config);\n    this.sendResource && watchResourceError(this.name);\n  }\n}\n","import { ajax } from \"../util/ajax.js\";\nexport function watchJsError(name, type, config) {\n  window.addEventListener(\n    \"error\",\n    (event) => {\n      if (!event.target.localName) {\n        ajax({\n          method: \"POST\",\n          url: \"http://localhost:8081/logapi/addErrorLog\",\n          data: {\n            title: event.error.message,\n            type: \"jsError\",\n            detail: encodeURI(event.error.stack),\n            component: name,\n            description: event.filename,\n          },\n        });\n        console.log(event);\n      }\n    },\n    true\n  );\n\n  window.addEventListener(\"unhandledrejection\", (event) => {\n    console.log(\"这是Promise场景中错误\", event);\n    ajax({\n      method: \"POST\",\n      url: \"http://localhost:8081/logapi/addErrorLog\",\n      data: {\n        title: event,\n        type: \"jsPromiseError\",\n      },\n    });\n  });\n\n  if (type == \"VUE\") {\n    config.errorHandler = function (err, vm, info) {\n      ajax({\n        method: \"POST\",\n        url: \"http://localhost:8081/logapi/addErrorLog\",\n        data: {\n          title: err.message,\n          type: \"vueError\",\n          detail: encodeURI(err.stack),\n          component: name,\n          description: `组件${vm.$vnode.tag}发生错误：${err.message}, ${info}`,\n        },\n      });\n      console.log(err);\n    };\n  }\n}\n","export function watchApiErrorXhr(name) {\n  function hijackXHR() {\n   \n    const proto = window.XMLHttpRequest.prototype;\n    const originalOpen = proto.open;\n    const originalSend = proto.send;\n    var _handleEvent = function (event) {\n      if (event && event.currentTarget && event.currentTarget.status !== 200) {\n        console.log(event.currentTarget, \"apiError\");\n        // 自定义错误上报 }\n      }\n    };\n    // proto.open = function (method, url, async) {\n    //   this._ctx = {\n    //     url: url || \"\",\n    //     method,\n    //   };\n    //   return originalOpen.apply(this, arguments);\n    // };\n    proto.send = function () {\n      if (this[\"addEventListener\"]) {\n        this[\"addEventListener\"](\"error\", _handleEvent);\n        this[\"addEventListener\"](\"load\", _handleEvent);\n        this[\"addEventListener\"](\"abort\", _handleEvent);\n      } else {\n        var _oldStateChange = this[\"onreadystatechange\"];\n        this[\"onreadystatechange\"] = function (event) {\n          if (this.readyState === 4) {\n            _handleEvent(event);\n          }\n          _oldStateChange && _oldStateChange.apply(this, arguments);\n        };\n      }\n      return originalSend.apply(this, arguments);\n    };\n\n\n  }\n  window.XMLHttpRequest && hijackXHR();\n}\n","export function watchApiErrorFetch(name) {\n  if (!window.fetch) return;\n  let _oldFetch = window.fetch;\n  window.fetch = function () {\n    return _oldFetch\n      .apply(this, arguments)\n      .then((res) => {\n        if (!res.ok) {\n          // True if status is HTTP 2xx\n          // 上报错误\n        }\n        return res;\n      })\n      .catch((error) => {\n        // 上报错误\n        throw error;\n      });\n  };\n}\n","export function watchResourceError(name) {\n  window.addEventListener(\n    \"error\",\n    (event) => {\n      if (event.target.localName) {\n        console.log(\"这是资源错误\", event);\n      }\n    },\n    true\n  );\n}\n"],"names":["ajax","opt","Promise","resolve","reject","xmlHttp","open","method","url","toUpperCase","send","JSON","stringify","data","setRequestHeader","body","onreadystatechange","readyState","status","responseText","parse","response","e","webMitoSdkInit","constructor","name","type","config","sendApi","sendResource","sendJsError","this","init","window","XMLHttpRequest","prototype","originalSend","proto","_handleEvent","event","currentTarget","console","log","_oldStateChange","apply","arguments","hijackXHR","watchApiErrorFetch","fetch","_oldFetch","then","res","catch","error","addEventListener","target","localName","title","message","detail","encodeURI","stack","component","description","filename","errorHandler","err","vm","info","$vnode","tag"],"mappings":"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"}